/*
 * FilePondPluginImageTransform 3.1.0
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */

/* eslint-disable */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.FilePondPluginImageTransform=e()}(this,function(){"use strict";var c={1:function(){return[1,0,0,1,0,0]},2:function(t){return[-1,0,0,1,t,0]},3:function(t,e){return[-1,0,0,-1,t,e]},4:function(t,e){return[1,0,0,-1,0,e]},5:function(){return[0,1,1,0,0,0]},6:function(t,e){return[0,1,-1,0,e,0]},7:function(t,e){return[0,-1,-1,0,e,t]},8:function(t){return[0,-1,1,0,0,t]}},w=function(t,e){return{x:t,y:e}},o=function(t,e){return w(t.x-e.x,t.y-e.y)},y=function(t,e){return Math.sqrt((a=o(n=t,i=e),r=o(n,i),a.x*r.x+a.y*r.y));var n,i,a,r},x=function(t,e){var n=t,i=e,a=1.5707963267948966-e,r=Math.sin(1.5707963267948966),o=Math.sin(i),h=Math.sin(a),u=Math.cos(a),l=n/r;return w(u*(l*o),u*(l*h))},O=function(t,e){var n,i,a,r,o,h,u,l,d,g=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,c=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{x:.5,y:.5},s=.5<c.x?1-c.x:c.x,f=.5<c.y?1-c.y:c.y,v=2*s*t.width,m=2*f*t.height,p=(i=g,a=(n=e).width,r=n.height,o=x(a,i),h=x(r,i),u=w(n.x+Math.abs(o.x),n.y-Math.abs(o.y)),l=w(n.x+n.width+Math.abs(h.y),n.y+Math.abs(h.x)),d=w(n.x-Math.abs(h.y),n.y+n.height-Math.abs(h.x)),{width:y(u,l),height:y(u,d)});return Math.max(p.width/v,p.height/m)},P=function(t,e){var n=t.width,i=n*e;return i>t.height&&(n=(i=t.height)/e),{x:.5*(t.width-n),y:.5*(t.height-i),width:n,height:i}},s=function(t){return t&&(t.horizontal||t.vertical)},v=function(t,e,n){if(!e&&!s(n))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;var i=document.createElement("canvas"),a=t.naturalWidth,r=t.naturalHeight,o=5<=e&&e<=8;i.height=o?(i.width=r,a):(i.width=a,r);var h,u,l,d=i.getContext("2d");if(e&&d.transform.apply(d,function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}((h=a,u=r,-1===(l=e)&&(l=1),c[l](h,u)))),s(n)){var g=[1,0,0,1,0,0];(!o&&n.horizontal||o&n.vertical)&&(g[0]=-1,g[4]=a),(!o&&n.vertical||o&&n.horizontal)&&(g[3]=-1,g[5]=r),d.transform.apply(d,g)}return d.drawImage(t,0,0,a,r),i},b=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=v(t,e,n.flip),a={width:i.width,height:i.height},r=document.createElement("canvas"),o=n.aspectRatio||a.height/a.width,h=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,i=t.height/t.width,a=e,r=1,o=i;a<o&&(r=(o=a)/i);var h=Math.max(1/r,a/o),u=t.width/(n*r*h),l=u*e;return{width:Math.round(u),height:Math.round(l)}}(a,o,n.zoom);r.width=h.width,r.height=h.height;var u={x:.5*r.width,y:.5*r.height},l=u.x-a.width*(n.center?n.center.x:.5),d=u.y-a.height*(n.center?n.center.y:.5),g={x:0,y:0,width:r.width,height:r.height,center:u},c=O(a,P(g,o),n.rotation,n.center),s=(n.zoom||1)*c,f=r.getContext("2d");return f.translate(u.x,u.y),f.rotate(n.rotation||0),f.scale(s,s),f.drawImage(i,l-u.x,d-u.y,a.width,a.height),f.getImageData(0,0,r.width,r.height)},A=function(){var a={resize:function(t,e){var n=e.mode,i=e.upscale,a=e.size,r=a.width,o=a.height;null===r?r=o:null===o&&(o=r);if("force"!==n){var h=r/t.width,u=o/t.height,l=1;if("cover"===n?l=Math.max(h,u):"contain"===n&&(l=Math.min(h,u)),1<l&&!1===i)return t;r=t.width*l,o=t.height*l}for(var d=t.width,g=t.height,c=Math.round(r),s=Math.round(o),f=t.data,v=new Uint8ClampedArray(c*s*4),m=d/c,p=g/s,w=Math.ceil(m/2),y=Math.ceil(p/2),x=0;x<s;x++)for(var M=0;M<c;M++){for(var T=4*(M+x*c),b=0,A=0,_=0,E=gx_g=gx_b=gx_a=0,U=(x+.5)*p,R=Math.floor(x*p);R<(x+1)*p;R++)for(var I=Math.abs(U-(R+.5))/y,O=(M+.5)*m,P=I*I,F=Math.floor(M*m);F<(M+1)*m;F++){var L=Math.abs(O-(F+.5))/w,B=Math.sqrt(P+L*L);-1<=B&&B<=1&&0<(b=2*B*B*B-3*B*B+1)&&(L=4*(F+R*d),gx_a+=b*f[L+3],_+=b,f[L+3]<255&&(b=b*f[L+3]/250),E+=b*f[L],gx_g+=b*f[L+1],gx_b+=b*f[L+2],A+=b)}v[T]=E/A,v[T+1]=gx_g/A,v[T+2]=gx_b/A,v[T+3]=gx_a/_}return{data:v,width:c,height:s}}},t=function(t,e){var n,i;e((n=t.transforms,i=t.imageData,n.forEach(function(t){i=a[t.type](i,t.data)}),i))};self.onmessage=function(e){t(e.data.message,function(t){self.postMessage({id:e.data.id,message:t},[t.data.buffer])})}},h=function(t,e,n){if(1165519206===t.getUint32(e+4,!1)){e+=4;var i=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,i);var a=t.getUint16(e,i);e+=2;for(var r=0;r<a;r++)if(274===t.getUint16(e+12*r,i))return t.setUint16(e+12*r+8,1,i),!0;return!1}},_=function(i){return new Promise(function(t,e){var n=new FileReader;n.onload=function(){return t(function(t){var e=new DataView(t);if(65496!==e.getUint16(0))return null;for(var n=2,i=void 0,a=void 0,r=!1;n<e.byteLength&&(i=e.getUint16(n,!1),a=e.getUint16(n+2,!1)+2,65504<=i&&i<=65519||65534===i)&&(r||(r=h(e,n)),!(n+a>e.byteLength));)n+=a;return t.slice(0,n)}(n.result)||null)},n.readAsArrayBuffer(i.slice(0,262144))})};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,r,o){var h=this;setTimeout(function(){for(var t=h.toDataURL(r,o).split(",")[1],e=atob(t),n=e.length,i=new Uint8Array(n);n--;)i[n]=e.charCodeAt(n);a(new Blob([i],{type:r||"image/png"}))})}});var t=function(t){var e=t.addFilter,n=t.utils,i=n.Type,f=n.forin,v=n.loadImage,m=n.getFileFromBlob,p=n.getFilenameWithoutExtension,w=n.createWorker,y=n.createBlob,x=n.renameFile,M=n.isFile;e("SHOULD_PREPARE_OUTPUT",function(t,e){var n=e.query;return new Promise(function(t){t(!n("IS_ASYNC"))})});var T=["resize"];return e("PREPARE_OUTPUT",function(g,t){var c=t.query,s=t.item;return new Promise(function(r,t){if(!M(g)||!/^image/.test(g.type)||!c("GET_ALLOW_IMAGE_TRANSFORM")||s.archived)return r(g);var e=c("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),a=null===e?null:e/100,n=c("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),o=c("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),h=s.getMetadata().crop,u=[];if(f(s.getMetadata(),function(t,e){T.includes(t)&&u.push({type:t,data:e})}),(null===a||null!==a&&"optional"===n)&&null===o&&!h&&!u.length)return r(g);var R,I,l=function(t,e){var i,a,n=function(t){var e,n,i,a=m(t,(e=g.name,i=t.type,n="image/jpeg"===i||"image/png"===i?i:"image/jpeg",p(e)+"."+("image/jpeg"===n?"jpg":n.split("/")[1])));r(a)};(i=t,a=e,new Promise(function(t,e){var n=document.createElement("canvas");n.width=i.width,n.height=i.height,n.getContext("2d").putImageData(i,0,0),n.toBlob(t,a.type,a.quality)})).then(function(e){c("GET_IMAGE_TRANSFORM_OUTPUT_STRIP_IMAGE_HEAD")?n(e):_(g).then(function(t){null!==t&&(e=new Blob([t,e.slice(20)],{type:e.type})),n(e)})}).catch(function(t){console.error(t)})};if(/svg/.test(g.type)&&null===o)return h?void(R=g,I=h,new Promise(function(E,t){var U=new FileReader;U.onloadend=function(){var t=U.result,e=document.createElement("div");e.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",e.innerHTML=t;var n=e.querySelector("svg");document.body.appendChild(e);var i=n.getBBox();e.parentNode.removeChild(e);var a=e.querySelector("title"),r=n.getAttribute("viewBox")||"",o=n.getAttribute("width")||"",h=n.getAttribute("height")||"",u=parseFloat(o)||null,l=parseFloat(h)||null,d=(o.match(/[a-z]+/)||[])[0]||"",g=(h.match(/[a-z]+/)||[])[0]||"",c=r.split(" ").map(parseFloat),s=c.length?{x:c[0],y:c[1],width:c[2],height:c[3]}:i,f=null!=u?u:s.width,v=null!=l?l:s.height;n.style.overflow="visible",n.setAttribute("width",f),n.setAttribute("height",v);var m=I.aspectRatio||v/f,p=f,w=p*m,y=O({width:f,height:v},P({width:p,height:w},m),I.rotation,I.center),x=I.zoom*y,M=.5*p,T=.5*w,b=["rotate("+I.rotation*(180/Math.PI)+" "+M+" "+T+")","translate("+M+" "+T+")","scale("+x+")","translate("+-M+" "+-T+")","translate("+(M-f*I.center.x)+" "+(T-v*I.center.y)+")"],A=["scale("+(I.flip.horizontal?-1:1)+" "+(I.flip.vertical?-1:1)+")","translate("+(I.flip.horizontal?-f:0)+" "+(I.flip.vertical?-v:0)+")"],_='<?xml version="1.0" encoding="UTF-8"?>\n<svg width="'+p+d+'" height="'+w+g+'" \nviewBox="0 0 '+p+" "+w+'" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>'+(a?a.textContent:R.name)+'</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="'+b.join(" ")+'">\n<g transform="'+A.join(" ")+'">\n'+n.outerHTML+"\n</g>\n</g>\n</svg>";E(_)},U.readAsText(R)})).then(function(t){r(x(y(t,"image/svg+xml"),g.name))}):r(g);var d=URL.createObjectURL(g);v(d).then(function(t){if(URL.revokeObjectURL(d),s.archived)return r(g);var e=(s.getMetadata("exif")||{}).orientation||-1,n=b(t,e,h);if(u.length){var i=w(A);i.post({transforms:u,imageData:n},function(t){if(s.archived)return r(g);l(function(e){var n=void 0;try{n=new ImageData(e.width,e.height)}catch(t){n=document.createElement("canvas").getContext("2d").createImageData(e.width,e.height)}return n.data.set(e.data),n}(t),{quality:a,type:o||g.type}),i.terminate()},[n.data.buffer])}else l(n,{quality:a,type:o||g.type})})})}),{options:{allowImageTransform:[!0,i.BOOLEAN],imageTransformOutputMimeType:[null,i.STRING],imageTransformOutputQuality:[null,i.INT],imageTransformOutputStripImageHead:[!0,i.BOOLEAN],imageTransformOutputQualityMode:["always",i.STRING]}}};return"undefined"!=typeof window&&void 0!==window.document&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:t})),t});