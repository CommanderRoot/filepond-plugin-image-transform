/*
 * FilePondPluginImageTransform 3.2.1
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */

/* eslint-disable */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.FilePondPluginImageTransform=e()}(this,function(){"use strict";var w=function(t,e){return{x:t,y:e}},o=function(t,e){return w(t.x-e.x,t.y-e.y)},y=function(t,e){return Math.sqrt((r=o(n=t,i=e),a=o(n,i),r.x*a.x+r.y*a.y));var n,i,r,a},T=function(t,e){var n=t,i=e,r=1.5707963267948966-e,a=Math.sin(1.5707963267948966),o=Math.sin(i),u=Math.sin(r),h=Math.cos(r),l=n/a;return w(h*(l*o),h*(l*u))},P=function(t,e){var n,i,r,a,o,u,h,l,c,f=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{x:.5,y:.5},g=.5<d.x?1-d.x:d.x,s=.5<d.y?1-d.y:d.y,m=2*g*t.width,v=2*s*t.height,p=(i=f,r=(n=e).width,a=n.height,o=T(r,i),u=T(a,i),h=w(n.x+Math.abs(o.x),n.y-Math.abs(o.y)),l=w(n.x+n.width+Math.abs(u.y),n.y+Math.abs(u.x)),c=w(n.x-Math.abs(u.y),n.y+n.height-Math.abs(u.x)),{width:y(h,l),height:y(h,c)});return Math.max(p.width/m,p.height/v)},G=function(t,e){var n=t.width,i=n*e;return i>t.height&&(n=(i=t.height)/e),{x:.5*(t.width-n),y:.5*(t.height-i),width:n,height:i}},d={1:function(){return[1,0,0,1,0,0]},2:function(t){return[-1,0,0,1,t,0]},3:function(t,e){return[-1,0,0,-1,t,e]},4:function(t,e){return[1,0,0,-1,0,e]},5:function(){return[0,1,1,0,0,0]},6:function(t,e){return[0,1,-1,0,e,0]},7:function(t,e){return[0,-1,-1,0,e,t]},8:function(t){return[0,-1,1,0,0,t]}},g=function(t){return t&&(t.horizontal||t.vertical)},m=function(t,e,n){if(!e&&!g(n))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;var i=document.createElement("canvas"),r=t.naturalWidth,a=t.naturalHeight,o=5<=e&&e<=8;i.height=o?(i.width=a,r):(i.width=r,a);var u,h,l,c=i.getContext("2d");if(e&&c.transform.apply(c,function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}((u=r,h=a,-1===(l=e)&&(l=1),d[l](u,h)))),g(n)){var f=[1,0,0,1,0,0];(!o&&n.horizontal||o&n.vertical)&&(f[0]=-1,f[4]=r),(!o&&n.vertical||o&&n.horizontal)&&(f[3]=-1,f[5]=a),c.transform.apply(c,f)}return c.drawImage(t,0,0,r,a),i},s=function(t,e,n){n||(n={});var i=m(t,e,n.flip),r={width:i.width,height:i.height},a=document.createElement("canvas"),o=n.aspectRatio||r.height/r.width,u=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,i=t.height/t.width,r=e,a=1,o=i;r<o&&(a=(o=r)/i);var u=Math.max(1/a,r/o),h=t.width/(n*a*u),l=h*e;return{width:Math.round(h),height:Math.round(l)}}(r,o,n.zoom);a.width=u.width,a.height=u.height;var h={x:.5*a.width,y:.5*a.height},l=h.x-r.width*(n.center?n.center.x:.5),c=h.y-r.height*(n.center?n.center.y:.5),f={x:0,y:0,width:a.width,height:a.height,center:h},d=P(r,G(f,o),n.rotation,n.center),g=(n.zoom||1)*d,s=a.getContext("2d");return s.translate(h.x,h.y),s.rotate(n.rotation||0),s.scale(g,g),s.drawImage(i,l-h.x,c-h.y,r.width,r.height),s.getImageData(0,0,a.width,a.height)},v=function(){var r={resize:function(t,e){var n=e.mode,i=e.upscale,r=e.size,a=r.width,o=r.height;null===a?a=o:null===o&&(o=a);if("force"!==n){var u=a/t.width,h=o/t.height,l=1;if("cover"===n?l=Math.max(u,h):"contain"===n&&(l=Math.min(u,h)),1<l&&!1===i)return t;a=t.width*l,o=t.height*l}for(var c=t.width,f=t.height,d=Math.round(a),g=Math.round(o),s=t.data,m=new Uint8ClampedArray(d*g*4),v=c/d,p=f/g,w=Math.ceil(v/2),y=Math.ceil(p/2),T=0;T<g;T++)for(var A=0;A<d;A++){for(var M=4*(A+T*d),_=0,x=0,E=0,I=gx_g=gx_b=gx_a=0,R=(T+.5)*p,O=Math.floor(T*p);O<(T+1)*p;O++)for(var b=Math.abs(R-(O+.5))/y,F=(A+.5)*v,N=b*b,U=Math.floor(A*v);U<(A+1)*v;U++){var P=Math.abs(F-(U+.5))/w,G=Math.sqrt(N+P*P);-1<=G&&G<=1&&0<(_=2*G*G*G-3*G*G+1)&&(P=4*(U+O*c),gx_a+=_*s[P+3],E+=_,s[P+3]<255&&(_=_*s[P+3]/250),I+=_*s[P],gx_g+=_*s[P+1],gx_b+=_*s[P+2],x+=_)}m[M]=I/x,m[M+1]=gx_g/x,m[M+2]=gx_b/x,m[M+3]=gx_a/E}return{data:m,width:d,height:g}}},t=function(t,e){var n,i;e((n=t.transforms,i=t.imageData,n.forEach(function(t){var e=r[t.type];e&&(i=e(i,t.data))}),i))};self.onmessage=function(e){t(e.data.message,function(t){self.postMessage({id:e.data.id,message:t},[t.data.buffer])})}},u=function(t,e,n){if(1165519206===t.getUint32(e+4,!1)){e+=4;var i=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,i);var r=t.getUint16(e,i);e+=2;for(var a=0;a<r;a++)if(274===t.getUint16(e+12*a,i))return t.setUint16(e+12*a+8,1,i),!0;return!1}},p=function(i){return new Promise(function(t,e){var n=new FileReader;n.onload=function(){return t(function(t){var e=new DataView(t);if(65496!==e.getUint16(0))return null;for(var n=2,i=void 0,r=void 0,a=!1;n<e.byteLength&&(i=e.getUint16(n,!1),r=e.getUint16(n+2,!1)+2,65504<=i&&i<=65519||65534===i)&&(a||(a=u(e,n)),!(n+r>e.byteLength));)n+=r;return t.slice(0,n)}(n.result)||null)},n.readAsArrayBuffer(i.slice(0,262144))})},f=function(t){var i=t.loadImage,l=t.createWorker,h=t.getFilenameWithoutExtension,c=t.getFileFromBlob,f=function(o,e,u){return new Promise(function(a,t){var i,r,n=function(t){var e,n,i,r=c(t,(e=o.name,i=t.type,n="image/jpeg"===i||"image/png"===i?i:"image/jpeg",h(e)+"."+("image/jpeg"===n?"jpg":n.split("/")[1])));a(r)};(i=e,r=u,new Promise(function(t,e){var n=document.createElement("canvas");n.width=i.width,n.height=i.height,n.getContext("2d").putImageData(i,0,0),n.toBlob(t,r.type,r.quality)})).then(function(e){u.stripImageHead?n(e):p(o).then(function(t){null!==t&&(e=new Blob([t,e.slice(20)],{type:e.type})),n(e)})}).catch(function(t){console.error(t)})})};return function(a,o,u,h){return new Promise(function(r,t){var e=function(t){if(a.archived)return r(o);var e=(u.find(function(t){return"crop"===t.type})||{}).data,n=s(t,(a.getMetadata("exif")||{}).orientation||-1,e);if(!u.length)return f(o,n,h).then(r);var i=l(v);i.post({transforms:u,imageData:n},function(t){if(a.archived)return r(o);f(o,function(e){var n=void 0;try{n=new ImageData(e.width,e.height)}catch(t){n=document.createElement("canvas").getContext("2d").createImageData(e.width,e.height)}return n.data.set(e.data),n}(t),h).then(r),i.terminate()},[n.data.buffer])},n=URL.createObjectURL(o);i(n).then(function(t){URL.revokeObjectURL(n),e(t)})})}};"undefined"!=typeof window&&void 0!==window.document&&(HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(r,a,o){var u=this;setTimeout(function(){for(var t=u.toDataURL(a,o).split(",")[1],e=atob(t),n=e.length,i=new Uint8Array(n);n--;)i[n]=e.charCodeAt(n);r(new Blob([i],{type:a||"image/png"}))})}}));var t=function(t){var e,N,U,n=t.addFilter,i=t.utils,r=i.Type,g=i.forin,a=i.loadImage,o=i.getFileFromBlob,u=i.getFilenameWithoutExtension,h=i.createWorker,l=i.createBlob,c=i.renameFile,s=i.isFile,m=["crop","resize"],v=f({loadImage:a,createWorker:h,getFileFromBlob:o,getFilenameWithoutExtension:u}),p=(N=(e={createBlob:l,renameFile:c}).createBlob,U=e.renameFile,function(b,F,e){return new Promise(function(I,t){var R=(e.find(function(t){return"crop"===t.type})||{}).data;if(!R)return I(F);var O=new FileReader;O.onloadend=function(){if(b.archived)return I(F);var t=O.result,e=document.createElement("div");e.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",e.innerHTML=t;var n=e.querySelector("svg");document.body.appendChild(e);var i=n.getBBox();e.parentNode.removeChild(e);var r=e.querySelector("title"),a=n.getAttribute("viewBox")||"",o=n.getAttribute("width")||"",u=n.getAttribute("height")||"",h=parseFloat(o)||null,l=parseFloat(u)||null,c=(o.match(/[a-z]+/)||[])[0]||"",f=(u.match(/[a-z]+/)||[])[0]||"",d=a.split(" ").map(parseFloat),g=d.length?{x:d[0],y:d[1],width:d[2],height:d[3]}:i,s=null!=h?h:g.width,m=null!=l?l:g.height;n.style.overflow="visible",n.setAttribute("width",s),n.setAttribute("height",m);var v=R.aspectRatio||m/s,p=s,w=p*v,y=P({width:s,height:m},G({width:p,height:w},v),R.rotation,R.center),T=R.zoom*y,A=.5*p,M=.5*w,_=["rotate("+R.rotation*(180/Math.PI)+" "+A+" "+M+")","translate("+A+" "+M+")","scale("+T+")","translate("+-A+" "+-M+")","translate("+(A-s*R.center.x)+" "+(M-m*R.center.y)+")"],x=["scale("+(R.flip.horizontal?-1:1)+" "+(R.flip.vertical?-1:1)+")","translate("+(R.flip.horizontal?-s:0)+" "+(R.flip.vertical?-m:0)+")"],E='<?xml version="1.0" encoding="UTF-8"?>\n<svg width="'+p+c+'" height="'+w+f+'" \nviewBox="0 0 '+p+" "+w+'" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>'+(r?r.textContent:F.name)+'</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="'+_.join(" ")+'">\n<g transform="'+x.join(" ")+'">\n'+n.outerHTML+"\n</g>\n</g>\n</svg>";I(U(N(E,"image/svg+xml"),F.name))},O.readAsText(F)})});return n("SHOULD_PREPARE_OUTPUT",function(t,e){var n=e.query;return new Promise(function(t){t(!n("IS_ASYNC"))})}),n("PREPARE_OUTPUT",function(c,t){var f=t.query,d=t.item;return new Promise(function(e){if(!s(c)||!/^image/.test(c.type)||!f("GET_ALLOW_IMAGE_TRANSFORM")||d.archived)return e(c);var n=[];f("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_ORIGINAL")&&n.push(function(){return new Promise(function(t){t({name:f("GET_IMAGE_TRANSFORM_VARIANTS_ORIGINAL_NAME"),file:c})})}),f("GET_IMAGE_TRANSFORM_VARIANTS_INCLUDE_DEFAULT")&&n.push(function(t,n,i){return new Promise(function(e){t(n,i).then(function(t){return e({name:f("GET_IMAGE_TRANSFORM_VARIANTS_DEFAULT_NAME"),file:t})})})});var t=f("GET_IMAGE_TRANSFORM_VARIANTS")||{};g(t,function(r,t){var i,a=(i=t,function(t,e,n){return t(e,i?i(n):n)});n.push(function(t,n,i){return new Promise(function(e){a(t,n,i).then(function(t){return e({name:r,file:t})})})})});var i=f("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),h=f("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),r=null===i?null:i/100,a=f("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),l=f("GET_IMAGE_TRANSFORM_CLIENT_TRANSFORMS")||m;d.setMetadata("output",{quality:r,type:a,client:l},!0);var o=function(o,u){return new Promise(function(t,e){var n=[];g(u,function(t,e){l.includes(t)&&n.push({type:t,data:e})}),n.sort(function(t,e){var n=m.indexOf(t.type),i=m.indexOf(e.type);return n<i?-1:i<n?1:0});var i=u.output||{},r=i.type,a=i.quality;return 0!==n.length||null!==a&&(null===a||"optional"!==h)||null!==r&&r!==o.type?/svg/.test(o.type)&&null===r?p(d,o,n).then(t):void v(d,o,n,{type:r||o.type,quality:a,stripImageHead:f("GET_IMAGE_TRANSFORM_OUTPUT_STRIP_IMAGE_HEAD")}).then(t):t(o)})},u=n.map(function(t){return t(o,c,d.getMetadata())});Promise.all(u).then(function(t){e(1===t.length&&null===t[0].name?t[0].file:t)})})}),{options:{allowImageTransform:[!0,r.BOOLEAN],imageTransformOutputMimeType:[null,r.STRING],imageTransformOutputQuality:[null,r.INT],imageTransformOutputStripImageHead:[!0,r.BOOLEAN],imageTransformClientTransforms:[null,r.ARRAY],imageTransformOutputQualityMode:["always",r.STRING],imageTransformVariants:[null,r.OBJECT],imageTransformVariantsIncludeDefault:[!0,r.BOOLEAN],imageTransformVariantsDefaultName:[null,r.STRING],imageTransformVariantsIncludeOriginal:[!1,r.BOOLEAN],imageTransformVariantsOriginalName:["original_",r.STRING]}}};return"undefined"!=typeof window&&void 0!==window.document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:t})),t});