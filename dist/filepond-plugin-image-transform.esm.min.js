/*
 * FilePondPluginImageTransform 3.0.2
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */

/* eslint-disable */
const isImage=t=>/^image/.test(t.type),transforms={1:()=>[1,0,0,1,0,0],2:t=>[-1,0,0,1,t,0],3:(t,e)=>[-1,0,0,-1,t,e],4:(t,e)=>[1,0,0,-1,0,e],5:()=>[0,1,1,0,0,0],6:(t,e)=>[0,1,-1,0,e,0],7:(t,e)=>[0,-1,-1,0,e,t],8:t=>[0,-1,1,0,0,t]},fixImageOrientation=(t,e,a,i)=>{-1!==i&&t.transform(...transforms[i](e,a))},createVector=(t,e)=>({x:t,y:e}),vectorDot=(t,e)=>t.x*e.x+t.y*e.y,vectorSubtract=(t,e)=>createVector(t.x-e.x,t.y-e.y),vectorDistanceSquared=(t,e)=>vectorDot(vectorSubtract(t,e),vectorSubtract(t,e)),vectorDistance=(t,e)=>Math.sqrt(vectorDistanceSquared(t,e)),getOffsetPointOnEdge=(t,e)=>{const a=t,i=e,n=1.5707963267948966-e,r=Math.sin(1.5707963267948966),o=Math.sin(i),h=Math.sin(n),s=Math.cos(n),c=a/r;return createVector(s*(c*o),s*(c*h))},getRotatedRectSize=(t,e)=>{const a=t.width,i=t.height,n=getOffsetPointOnEdge(a,e),r=getOffsetPointOnEdge(i,e),o=createVector(t.x+Math.abs(n.x),t.y-Math.abs(n.y)),h=createVector(t.x+t.width+Math.abs(r.y),t.y+Math.abs(r.x)),s=createVector(t.x-Math.abs(r.y),t.y+t.height-Math.abs(r.x));return{width:vectorDistance(o,h),height:vectorDistance(o,s)}},getImageRectZoomFactor=(t,e,a=0,i={x:.5,y:.5})=>{const n=i.x>.5?1-i.x:i.x,r=i.y>.5?1-i.y:i.y,o=2*n*t.width,h=2*r*t.height,s=getRotatedRectSize(e,a);return Math.max(s.width/o,s.height/h)},getCenteredCropRect=(t,e)=>{let a=t.width,i=a*e;i>t.height&&(a=(i=t.height)/e);return{x:.5*(t.width-a),y:.5*(t.height-i),width:a,height:i}},calculateCanvasSize=(t,e,a=1)=>{const i=t.height/t.width;let n=e,r=1,o=i;o>n&&(r=(o=n)/i);const h=Math.max(1/r,n/o),s=t.width/(a*r*h),c=s*e;return{width:Math.round(s),height:Math.round(c)}},isFlipped=t=>t&&(t.horizontal||t.vertical),getBitmap=(t,e,a)=>{if(!e&&!isFlipped(a))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;const i=document.createElement("canvas"),n=t.naturalWidth,r=t.naturalHeight;e>=5&&e<=8?(i.width=r,i.height=n):(i.width=n,i.height=r);const o=i.getContext("2d");return e&&(o.save(),fixImageOrientation(o,n,r,e),o.restore()),isFlipped(a)&&(o.translate(.5*i.width,.5*i.height),o.scale(a.horizontal?-1:1,a.vertical?-1:1),o.translate(.5*-i.width,.5*-i.height)),o.drawImage(t,0,0,n,r),i},imageToImageData=(t,e,a={})=>{const i=getBitmap(t,e,a.flip),n={width:i.width,height:i.height},r=document.createElement("canvas"),o=a.aspectRatio||n.height/n.width,h=calculateCanvasSize(n,o,a.zoom);r.width=h.width,r.height=h.height;const s={x:.5*r.width,y:.5*r.height},c={x:s.x-n.width*(a.center?a.center.x:.5),y:s.y-n.height*(a.center?a.center.y:.5)},g={x:0,y:0,width:r.width,height:r.height,center:s},l=getImageRectZoomFactor(n,getCenteredCropRect(g,o),a.rotation,a.center),d=(a.zoom||1)*l,m=r.getContext("2d");return m.translate(s.x,s.y),m.rotate(a.rotation||0),m.scale(d,d),m.drawImage(i,c.x-s.x,c.y-s.y,n.width,n.height),m.getImageData(0,0,r.width,r.height)},cropSVG=(t,e)=>new Promise((a,i)=>{const n=new FileReader;n.onloadend=(()=>{const i=n.result,r=document.createElement("div");r.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",r.innerHTML=i;const o=r.querySelector("svg");document.body.appendChild(r);const h=o.getBBox();r.parentNode.removeChild(r);const s=r.querySelector("title"),c=o.getAttribute("viewBox")||"",g=o.getAttribute("width")||"",l=o.getAttribute("height")||"";let d=parseFloat(g)||null,m=parseFloat(l)||null;const u=(g.match(/[a-z]+/)||[])[0]||"",p=(l.match(/[a-z]+/)||[])[0]||"",w=c.split(" ").map(parseFloat),x=w.length?{x:w[0],y:w[1],width:w[2],height:w[3]}:h;let y=null!=d?d:x.width,f=null!=m?m:x.height;o.style.overflow="visible",o.setAttribute("width",y),o.setAttribute("height",f);const v=e.aspectRatio||f/y,M=y,T=M*v,b=getImageRectZoomFactor({width:y,height:f},getCenteredCropRect({width:M,height:T},v),e.rotation,e.center),I=e.zoom*b,R=e.rotation*(180/Math.PI),$={x:.5*M,y:.5*T},E={x:$.x-y*e.center.x,y:$.y-f*e.center.y},_=[`rotate(${R} ${$.x} ${$.y})`,`translate(${$.x} ${$.y})`,`scale(${I})`,`translate(${-$.x} ${-$.y})`,`translate(${E.x} ${E.y})`],O=[`scale(${e.flip.horizontal?-1:1} ${e.flip.vertical?-1:1})`,`translate(${e.flip.horizontal?-y:0} ${e.flip.vertical?-f:0})`],F=`<?xml version="1.0" encoding="UTF-8"?>\n<svg width="${M}${u}" height="${T}${p}" \nviewBox="0 0 ${M} ${T}" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>${s?s.textContent:t.name}</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="${_.join(" ")}">\n<g transform="${O.join(" ")}">\n${o.outerHTML}\n</g>\n</g>\n</svg>`;a(F)}),n.readAsText(t)}),imageDataToBlob=(t,e)=>new Promise((a,i)=>{const n=document.createElement("canvas");n.width=t.width,n.height=t.height;n.getContext("2d").putImageData(t,0,0),n.toBlob(a,e.type,e.quality)}),objectToImageData=t=>{let e;try{e=new ImageData(t.width,t.height)}catch(a){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e},TransformWorker=()=>{const t={resize:function(t,e){const{mode:a,upscale:i}=e;let{width:n,height:r}=e.size;if(null===n?n=r:null===r&&(r=n),"force"!==a){let e=n/t.width,o=r/t.height,h=1;if("cover"===a?h=Math.max(e,o):"contain"===a&&(h=Math.min(e,o)),h>1&&!1===i)return t;n=t.width*h,r=t.height*h}const o=t.width,h=t.height,s=Math.round(n),c=Math.round(r);for(var g=t.data,l=new Uint8ClampedArray(s*c*4),d=o/s,m=h/c,u=Math.ceil(d/2),p=Math.ceil(m/2),w=0;w<c;w++)for(var x=0;x<s;x++){for(var y=4*(x+w*s),f=0,v=0,M=0,T=gx_g=gx_b=gx_a=0,b=(w+.5)*m,I=Math.floor(w*m);I<(w+1)*m;I++)for(var R=Math.abs(b-(I+.5))/p,$=(x+.5)*d,E=R*R,_=Math.floor(x*d);_<(x+1)*d;_++){var O=Math.abs($-(_+.5))/u,F=Math.sqrt(E+O*O);F>=-1&&F<=1&&(f=2*F*F*F-3*F*F+1)>0&&(O=4*(_+I*o),gx_a+=f*g[O+3],M+=f,g[O+3]<255&&(f=f*g[O+3]/250),T+=f*g[O],gx_g+=f*g[O+1],gx_b+=f*g[O+2],v+=f)}l[y]=T/v,l[y+1]=gx_g/v,l[y+2]=gx_b/v,l[y+3]=gx_a/M}return{data:l,width:s,height:c}}};self.onmessage=(e=>{((e,a)=>{a(((e,a)=>(e.forEach(e=>{a=t[e.type](a,e.data)}),a))(e.transforms,e.imageData))})(e.data.message,t=>{self.postMessage({id:e.data.id,message:t},[t.data.buffer])})})};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,a){const i=this;setTimeout(()=>{const n=i.toDataURL(e,a).split(",")[1],r=atob(n);let o=r.length;const h=new Uint8Array(o);for(;o--;)h[o]=r.charCodeAt(o);t(new Blob([h],{type:e||"image/png"}))})}});var plugin$1=t=>{const{addFilter:e,utils:a}=t,{Type:i,forin:n,loadImage:r,getFileFromBlob:o,getFilenameWithoutExtension:h,createWorker:s,createBlob:c,renameFile:g,isFile:l}=a,d=["resize"];return e("PREPARE_OUTPUT",(t,{query:e,item:a})=>new Promise((i,m)=>{if(!l(t)||!isImage(t)||!e("GET_ALLOW_IMAGE_TRANSFORM")||a.archived)return i(t);const u=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),p=null===u?null:u/100,w=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),x=e("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),{crop:y}=a.getMetadata(),f=[];if(n(a.getMetadata(),(t,e)=>{d.includes(t)&&f.push({type:t,data:e})}),(null===p||null!==p&&"optional"===w)&&null===x&&!y&&!f.length)return i(t);const v=(e,a)=>{imageDataToBlob(e,a).then(e=>{const a=o(e,((t,e)=>{return`${h(t)}.${"image/jpeg"===e?"jpg":e.split("/")[1]}`})(t.name,(t=>"image/jpeg"===t||"image/png"===t?t:"image/jpeg")(e.type)));i(a)}).catch(t=>{console.error(t)})},M=URL.createObjectURL(t);if(/svg/.test(t.type)&&null===x)return y?void cropSVG(t,y).then(e=>{i(g(c(e,"image/svg+xml"),t.name))}):i(t);r(M).then(e=>{if(URL.revokeObjectURL(M),a.archived)return i(t);const n=(a.getMetadata("exif")||{}).orientation||-1,r=imageToImageData(e,n,y);if(!f.length)return void v(r,{quality:p,type:x||t.type});const o=s(TransformWorker);o.post({transforms:f,imageData:r},e=>{if(a.archived)return i(t);v(objectToImageData(e),{quality:p,type:x||t.type}),o.terminate()},[r.data.buffer])})})),{options:{allowImageTransform:[!0,i.BOOLEAN],imageTransformOutputMimeType:[null,i.STRING],imageTransformOutputQuality:[null,i.INT],imageTransformOutputQualityMode:["always",i.STRING]}}};const isBrowser="undefined"!=typeof window&&void 0!==window.document;isBrowser&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:plugin$1}));export default plugin$1;