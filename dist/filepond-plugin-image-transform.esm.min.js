/*
 * FilePondPluginImageTransform 1.1.0
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
const isImage=t=>/^image/.test(t.type),transforms={1:()=>[1,0,0,1,0,0],2:t=>[-1,0,0,1,t,0],3:(t,e)=>[-1,0,0,-1,t,e],4:(t,e)=>[1,0,0,-1,0,e],5:[0,1,1,0,0,0],6:(t,e)=>[0,1,-1,0,e,0],7:(t,e)=>[0,-1,-1,0,e,t],8:t=>[0,-1,1,0,0,t]},fixImageOrientation=(t,e,a,n)=>{-1!==n&&t.transform(...transforms[n](e,a))},imageToImageData=(t,e,a)=>{e||(e={x:0,y:0,width:1,height:1});const n=document.createElement("canvas"),o=t.naturalWidth,r=t.naturalHeight;a>=5&&a<=8?(n.width=r,n.height=o):(n.width=o,n.height=r);const i=n.getContext("2d");i.save(),fixImageOrientation(i,o,r,a),i.drawImage(t,0,0,o,r),i.restore();return i.getImageData(Math.round(e.x*n.width),Math.round(e.y*n.height),Math.round(e.width*n.width),Math.round(e.height*n.height))},imageDataToBlob=(t,e)=>new Promise((a,n)=>{const o=document.createElement("canvas");o.width=t.width,o.height=t.height;o.getContext("2d").putImageData(t,0,0),o.toBlob(a,e.type,e.quality)}),objectToImageData=t=>{let e;try{e=new ImageData(t.width,t.height)}catch(a){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e},TransformWorker=()=>{const t={resize:function(t,e){const{mode:a,upscale:n}=e;let{width:o,height:r}=e.size;if(null===o?o=r:null===r&&(r=o),"force"!==a){let e=o/t.width,i=r/t.height,g=1;if("cover"===a?g=Math.max(e,i):"contain"===a&&(g=Math.min(e,i)),g>1&&!1===n)return t;o=t.width*g,r=t.height*g}const i=t.width,g=t.height,h=Math.round(o),s=Math.round(r);for(var l=t.data,m=new Uint8ClampedArray(h*s*4),d=i/h,u=g/s,c=Math.ceil(d/2),p=Math.ceil(u/2),f=0;f<s;f++)for(var T=0;T<h;T++){for(var M=4*(T+f*h),y=0,w=0,I=0,_=gx_g=gx_b=gx_a=0,b=(f+.5)*u,x=Math.floor(f*u);x<(f+1)*u;x++)for(var E=Math.abs(b-(x+.5))/p,v=(T+.5)*d,O=E*E,R=Math.floor(T*d);R<(T+1)*d;R++){var U=Math.abs(v-(R+.5))/c,A=Math.sqrt(O+U*U);A>=-1&&A<=1&&(y=2*A*A*A-3*A*A+1)>0&&(U=4*(R+x*i),gx_a+=y*l[U+3],I+=y,l[U+3]<255&&(y=y*l[U+3]/250),_+=y*l[U],gx_g+=y*l[U+1],gx_b+=y*l[U+2],w+=y)}m[M]=_/w,m[M+1]=gx_g/w,m[M+2]=gx_b/w,m[M+3]=gx_a/I}return{data:m,width:h,height:s}}};self.onmessage=(e=>{((e,a)=>{a(((e,a)=>(e.forEach(e=>{a=t[e.type](a,e.data)}),a))(e.transforms,e.imageData))})(e.data.message,t=>{self.postMessage({id:e.data.id,message:t},[t.data.buffer])})})};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,a){const n=this;setTimeout(()=>{const o=n.toDataURL(e,a).split(",")[1],r=atob(o);let i=r.length;const g=new Uint8Array(i);for(;i--;)g[i]=r.charCodeAt(i);t(new Blob([g],{type:e||"image/png"}))})}});var plugin$1=t=>{const{addFilter:e,utils:a}=t,{Type:n,forin:o,loadImage:r,getFileFromBlob:i,getFilenameWithoutExtension:g,createWorker:h}=a,s=["resize"];return e("PREPARE_OUTPUT",(t,{query:e,item:a})=>new Promise((n,l)=>{if(!isImage(t)||!e("GET_ALLOW_IMAGE_TRANSFORM"))return n(t);const m=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),d=null===m?null:m/100,u=e("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),{crop:c}=a.getMetadata(),p=[];if(o(a.getMetadata(),(t,e)=>{s.includes(t)&&p.push({type:t,data:e})}),null===d&&null===u&&!c&&!p.length)return n(t);const f=(e,a)=>{imageDataToBlob(e,a).then(e=>{const a=i(e,((t,e)=>{return`${g(t)}.${"image/jpeg"===e?"jpg":e.split("/")[1]}`})(t.name,(t=>"image/jpeg"===t||"image/png"===t?t:"image/jpeg")(e.type)));n(a)}).catch(t=>{console.error(t)})},T=URL.createObjectURL(t);r(T).then(e=>{URL.revokeObjectURL(T);const n=(a.getMetadata("exif")||{}).orientation||-1,o=imageToImageData(e,c?c.rect:null,n);if(!p.length)return void f(o,{quality:d,type:u||t.type});const r=h(TransformWorker);r.post({transforms:p,imageData:o},e=>{f(objectToImageData(e),{quality:d,type:u||t.type}),r.terminate()},[o.data.buffer])})})),{options:{allowImageTransform:[!0,n.BOOLEAN],imageTransformOutputMimeType:[null,n.STRING],imageTransformOutputQuality:[null,n.INT]}}};"undefined"!=typeof navigator&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:plugin$1}));export default plugin$1;