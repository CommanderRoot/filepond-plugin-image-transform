/*
 * FilePondPluginImageTransform 3.1.0
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */

/* eslint-disable */
const isImage=t=>/^image/.test(t.type),MATRICES={1:()=>[1,0,0,1,0,0],2:t=>[-1,0,0,1,t,0],3:(t,e)=>[-1,0,0,-1,t,e],4:(t,e)=>[1,0,0,-1,0,e],5:()=>[0,1,1,0,0,0],6:(t,e)=>[0,1,-1,0,e,0],7:(t,e)=>[0,-1,-1,0,e,t],8:t=>[0,-1,1,0,0,t]},getImageOrientationMatrix=(t,e,a)=>(-1===a&&(a=1),MATRICES[a](t,e)),createVector=(t,e)=>({x:t,y:e}),vectorDot=(t,e)=>t.x*e.x+t.y*e.y,vectorSubtract=(t,e)=>createVector(t.x-e.x,t.y-e.y),vectorDistanceSquared=(t,e)=>vectorDot(vectorSubtract(t,e),vectorSubtract(t,e)),vectorDistance=(t,e)=>Math.sqrt(vectorDistanceSquared(t,e)),getOffsetPointOnEdge=(t,e)=>{const a=t,i=e,n=1.5707963267948966-e,r=Math.sin(1.5707963267948966),o=Math.sin(i),h=Math.sin(n),s=Math.cos(n),c=a/r;return createVector(s*(c*o),s*(c*h))},getRotatedRectSize=(t,e)=>{const a=t.width,i=t.height,n=getOffsetPointOnEdge(a,e),r=getOffsetPointOnEdge(i,e),o=createVector(t.x+Math.abs(n.x),t.y-Math.abs(n.y)),h=createVector(t.x+t.width+Math.abs(r.y),t.y+Math.abs(r.x)),s=createVector(t.x-Math.abs(r.y),t.y+t.height-Math.abs(r.x));return{width:vectorDistance(o,h),height:vectorDistance(o,s)}},getImageRectZoomFactor=(t,e,a=0,i={x:.5,y:.5})=>{const n=i.x>.5?1-i.x:i.x,r=i.y>.5?1-i.y:i.y,o=2*n*t.width,h=2*r*t.height,s=getRotatedRectSize(e,a);return Math.max(s.width/o,s.height/h)},getCenteredCropRect=(t,e)=>{let a=t.width,i=a*e;i>t.height&&(a=(i=t.height)/e);return{x:.5*(t.width-a),y:.5*(t.height-i),width:a,height:i}},calculateCanvasSize=(t,e,a=1)=>{const i=t.height/t.width;let n=e,r=1,o=i;o>n&&(r=(o=n)/i);const h=Math.max(1/r,n/o),s=t.width/(a*r*h),c=s*e;return{width:Math.round(s),height:Math.round(c)}},isFlipped=t=>t&&(t.horizontal||t.vertical),getBitmap=(t,e,a)=>{if(!e&&!isFlipped(a))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;const i=document.createElement("canvas"),n=t.naturalWidth,r=t.naturalHeight,o=e>=5&&e<=8;o?(i.width=r,i.height=n):(i.width=n,i.height=r);const h=i.getContext("2d");if(e&&h.transform(...getImageOrientationMatrix(n,r,e)),isFlipped(a)){const t=[1,0,0,1,0,0];(!o&&a.horizontal||o&a.vertical)&&(t[0]=-1,t[4]=n),(!o&&a.vertical||o&&a.horizontal)&&(t[3]=-1,t[5]=r),h.transform(...t)}return h.drawImage(t,0,0,n,r),i},imageToImageData=(t,e,a={})=>{const i=getBitmap(t,e,a.flip),n={width:i.width,height:i.height},r=document.createElement("canvas"),o=a.aspectRatio||n.height/n.width,h=calculateCanvasSize(n,o,a.zoom);r.width=h.width,r.height=h.height;const s={x:.5*r.width,y:.5*r.height},c={x:s.x-n.width*(a.center?a.center.x:.5),y:s.y-n.height*(a.center?a.center.y:.5)},g={x:0,y:0,width:r.width,height:r.height,center:s},l=getImageRectZoomFactor(n,getCenteredCropRect(g,o),a.rotation,a.center),d=(a.zoom||1)*l,u=r.getContext("2d");return u.translate(s.x,s.y),u.rotate(a.rotation||0),u.scale(d,d),u.drawImage(i,c.x-s.x,c.y-s.y,n.width,n.height),u.getImageData(0,0,r.width,r.height)},cropSVG=(t,e)=>new Promise((a,i)=>{const n=new FileReader;n.onloadend=(()=>{const i=n.result,r=document.createElement("div");r.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",r.innerHTML=i;const o=r.querySelector("svg");document.body.appendChild(r);const h=o.getBBox();r.parentNode.removeChild(r);const s=r.querySelector("title"),c=o.getAttribute("viewBox")||"",g=o.getAttribute("width")||"",l=o.getAttribute("height")||"";let d=parseFloat(g)||null,u=parseFloat(l)||null;const m=(g.match(/[a-z]+/)||[])[0]||"",p=(l.match(/[a-z]+/)||[])[0]||"",w=c.split(" ").map(parseFloat),y=w.length?{x:w[0],y:w[1],width:w[2],height:w[3]}:h;let f=null!=d?d:y.width,x=null!=u?u:y.height;o.style.overflow="visible",o.setAttribute("width",f),o.setAttribute("height",x);const M=e.aspectRatio||x/f,v=f,T=v*M,b=getImageRectZoomFactor({width:f,height:x},getCenteredCropRect({width:v,height:T},M),e.rotation,e.center),I=e.zoom*b,R=e.rotation*(180/Math.PI),E={x:.5*v,y:.5*T},_={x:E.x-f*e.center.x,y:E.y-x*e.center.y},O=[`rotate(${R} ${E.x} ${E.y})`,`translate(${E.x} ${E.y})`,`scale(${I})`,`translate(${-E.x} ${-E.y})`,`translate(${_.x} ${_.y})`],A=[`scale(${e.flip.horizontal?-1:1} ${e.flip.vertical?-1:1})`,`translate(${e.flip.horizontal?-f:0} ${e.flip.vertical?-x:0})`],U=`<?xml version="1.0" encoding="UTF-8"?>\n<svg width="${v}${m}" height="${T}${p}" \nviewBox="0 0 ${v} ${T}" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>${s?s.textContent:t.name}</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="${O.join(" ")}">\n<g transform="${A.join(" ")}">\n${o.outerHTML}\n</g>\n</g>\n</svg>`;a(U)}),n.readAsText(t)}),imageDataToBlob=(t,e)=>new Promise((a,i)=>{const n=document.createElement("canvas");n.width=t.width,n.height=t.height;n.getContext("2d").putImageData(t,0,0),n.toBlob(a,e.type,e.quality)}),objectToImageData=t=>{let e;try{e=new ImageData(t.width,t.height)}catch(a){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e},TransformWorker=()=>{const t={resize:function(t,e){const{mode:a,upscale:i}=e;let{width:n,height:r}=e.size;if(null===n?n=r:null===r&&(r=n),"force"!==a){let e=n/t.width,o=r/t.height,h=1;if("cover"===a?h=Math.max(e,o):"contain"===a&&(h=Math.min(e,o)),h>1&&!1===i)return t;n=t.width*h,r=t.height*h}const o=t.width,h=t.height,s=Math.round(n),c=Math.round(r);for(var g=t.data,l=new Uint8ClampedArray(s*c*4),d=o/s,u=h/c,m=Math.ceil(d/2),p=Math.ceil(u/2),w=0;w<c;w++)for(var y=0;y<s;y++){for(var f=4*(y+w*s),x=0,M=0,v=0,T=gx_g=gx_b=gx_a=0,b=(w+.5)*u,I=Math.floor(w*u);I<(w+1)*u;I++)for(var R=Math.abs(b-(I+.5))/p,E=(y+.5)*d,_=R*R,O=Math.floor(y*d);O<(y+1)*d;O++){var A=Math.abs(E-(O+.5))/m,U=Math.sqrt(_+A*A);U>=-1&&U<=1&&(x=2*U*U*U-3*U*U+1)>0&&(A=4*(O+I*o),gx_a+=x*g[A+3],v+=x,g[A+3]<255&&(x=x*g[A+3]/250),T+=x*g[A],gx_g+=x*g[A+1],gx_b+=x*g[A+2],M+=x)}l[f]=T/M,l[f+1]=gx_g/M,l[f+2]=gx_b/M,l[f+3]=gx_a/v}return{data:l,width:s,height:c}}};self.onmessage=(e=>{((e,a)=>{a(((e,a)=>(e.forEach(e=>{a=t[e.type](a,e.data)}),a))(e.transforms,e.imageData))})(e.data.message,t=>{self.postMessage({id:e.data.id,message:t},[t.data.buffer])})})},correctOrientation=(t,e,a)=>{if(1165519206!==t.getUint32(e+4,!1))return;e+=4;const i=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,i);const n=t.getUint16(e,i);e+=2;for(let a=0;a<n;a++)if(274===t.getUint16(e+12*a,i))return t.setUint16(e+12*a+8,1,i),!0;return!1},readData=t=>{const e=new DataView(t);if(65496!==e.getUint16(0))return null;let a,i,n=2,r=!1;for(;n<e.byteLength;){a=e.getUint16(n,!1),i=e.getUint16(n+2,!1)+2;if(!(a>=65504&&a<=65519||65534===a))break;if(r||(r=correctOrientation(e,n)),n+i>e.byteLength)break;n+=i}return t.slice(0,n)},getImageHead=t=>new Promise((e,a)=>{const i=new FileReader;i.onload=(()=>e(readData(i.result)||null)),i.readAsArrayBuffer(t.slice(0,262144))});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,a){const i=this;setTimeout(()=>{const n=i.toDataURL(e,a).split(",")[1],r=atob(n);let o=r.length;const h=new Uint8Array(o);for(;o--;)h[o]=r.charCodeAt(o);t(new Blob([h],{type:e||"image/png"}))})}});var plugin$1=t=>{const{addFilter:e,utils:a}=t,{Type:i,forin:n,loadImage:r,getFileFromBlob:o,getFilenameWithoutExtension:h,createWorker:s,createBlob:c,renameFile:g,isFile:l}=a;e("SHOULD_PREPARE_OUTPUT",(t,{query:e,item:a})=>new Promise(t=>{t(!e("IS_ASYNC"))}));const d=["resize"];return e("PREPARE_OUTPUT",(t,{query:e,item:a})=>new Promise((i,u)=>{if(!l(t)||!isImage(t)||!e("GET_ALLOW_IMAGE_TRANSFORM")||a.archived)return i(t);const m=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),p=null===m?null:m/100,w=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),y=e("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),{crop:f}=a.getMetadata(),x=[];if(n(a.getMetadata(),(t,e)=>{d.includes(t)&&x.push({type:t,data:e})}),(null===p||null!==p&&"optional"===w)&&null===y&&!f&&!x.length)return i(t);const M=(a,n)=>{const r=e=>{const a=o(e,((t,e)=>{return`${h(t)}.${"image/jpeg"===e?"jpg":e.split("/")[1]}`})(t.name,(t=>"image/jpeg"===t||"image/png"===t?t:"image/jpeg")(e.type)));i(a)};imageDataToBlob(a,n).then(a=>{e("GET_IMAGE_TRANSFORM_OUTPUT_STRIP_IMAGE_HEAD")?r(a):getImageHead(t).then(t=>{null!==t&&(a=new Blob([t,a.slice(20)],{type:a.type})),r(a)})}).catch(t=>{console.error(t)})};if(/svg/.test(t.type)&&null===y)return f?void cropSVG(t,f).then(e=>{i(g(c(e,"image/svg+xml"),t.name))}):i(t);const v=URL.createObjectURL(t);r(v).then(e=>{if(URL.revokeObjectURL(v),a.archived)return i(t);const n=(a.getMetadata("exif")||{}).orientation||-1,r=imageToImageData(e,n,f);if(!x.length)return void M(r,{quality:p,type:y||t.type});const o=s(TransformWorker);o.post({transforms:x,imageData:r},e=>{if(a.archived)return i(t);M(objectToImageData(e),{quality:p,type:y||t.type}),o.terminate()},[r.data.buffer])})})),{options:{allowImageTransform:[!0,i.BOOLEAN],imageTransformOutputMimeType:[null,i.STRING],imageTransformOutputQuality:[null,i.INT],imageTransformOutputStripImageHead:[!0,i.BOOLEAN],imageTransformOutputQualityMode:["always",i.STRING]}}};const isBrowser="undefined"!=typeof window&&void 0!==window.document;isBrowser&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:plugin$1}));export default plugin$1;