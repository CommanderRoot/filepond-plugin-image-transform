/*
 * FilePondPluginImageTransform 1.0.0
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
const isImage=t=>/^image/.test(t.type),transforms={1:()=>[1,0,0,1,0,0],2:t=>[-1,0,0,1,t,0],3:(t,e)=>[-1,0,0,-1,t,e],4:(t,e)=>[1,0,0,-1,0,e],5:[0,1,1,0,0,0],6:(t,e)=>[0,1,-1,0,e,0],7:(t,e)=>[0,-1,-1,0,e,t],8:t=>[0,-1,1,0,0,t]},fixImageOrientation=(t,e,a,n)=>{-1!==n&&t.transform(...transforms[n](e,a))},imageToImageData=(t,e,a)=>{e||(e={x:0,y:0,width:1,height:1});const n=document.createElement("canvas"),o=t.naturalWidth,r=t.naturalHeight;a>=5&&a<=8?(n.width=r,n.height=o):(n.width=o,n.height=r);const i=n.getContext("2d");i.save(),fixImageOrientation(i,o,r,a),i.drawImage(t,0,0,o,r),i.restore();return i.getImageData(Math.round(e.x*n.width),Math.round(e.y*n.height),Math.round(e.width*n.width),Math.round(e.height*n.height))},imageDataToBlob=(t,e)=>new Promise((a,n)=>{const o=document.createElement("canvas");o.width=t.width,o.height=t.height;o.getContext("2d").putImageData(t,0,0),o.toBlob(a,e.type,e.quality)}),objectToImageData=t=>{let e;try{e=new ImageData(t.width,t.height)}catch(a){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e},TransformWorker=()=>{const t={resize:function(t,e){const{mode:a}=e;let{width:n,height:o}=e.size;if(null===n?n=o:null===o&&(o=n),"force"!==a){let e=n/t.width,r=o/t.height,i=1;"cover"===a?i=Math.max(e,r):"contain"===a&&(i=Math.min(e,r)),n=t.width*i,o=t.height*i}const r=t.width,i=t.height,g=Math.round(n),h=Math.round(o);for(var s=t.data,l=new Uint8ClampedArray(g*h*4),m=r/g,d=i/h,u=Math.ceil(m/2),c=Math.ceil(d/2),p=0;p<h;p++)for(var f=0;f<g;f++){for(var T=4*(f+p*g),M=0,y=0,w=0,I=gx_g=gx_b=gx_a=0,_=(p+.5)*d,b=Math.floor(p*d);b<(p+1)*d;b++)for(var x=Math.abs(_-(b+.5))/c,E=(f+.5)*m,v=x*x,O=Math.floor(f*m);O<(f+1)*m;O++){var R=Math.abs(E-(O+.5))/u,U=Math.sqrt(v+R*R);U>=-1&&U<=1&&(M=2*U*U*U-3*U*U+1)>0&&(R=4*(O+b*r),gx_a+=M*s[R+3],w+=M,s[R+3]<255&&(M=M*s[R+3]/250),I+=M*s[R],gx_g+=M*s[R+1],gx_b+=M*s[R+2],y+=M)}l[T]=I/y,l[T+1]=gx_g/y,l[T+2]=gx_b/y,l[T+3]=gx_a/w}return{data:l,width:g,height:h}}};self.onmessage=(e=>{((e,a)=>{a(((e,a)=>(e.forEach(e=>{a=t[e.type](a,e.data)}),a))(e.transforms,e.imageData))})(e.data.message,t=>{self.postMessage({id:e.data.id,message:t},[t.data.buffer])})})};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,a){const n=this;setTimeout(()=>{const o=n.toDataURL(e,a).split(",")[1],r=atob(o);let i=r.length;const g=new Uint8Array(i);for(;i--;)g[i]=r.charCodeAt(i);t(new Blob([g],{type:e||"image/png"}))})}});var plugin$1=t=>{const{addFilter:e,utils:a}=t,{Type:n,forin:o,loadImage:r,getFileFromBlob:i,getFilenameWithoutExtension:g,createWorker:h}=a,s=["resize"];return e("PREPARE_OUTPUT",(t,{query:e,item:a})=>new Promise((n,l)=>{if(!isImage(t)||!e("GET_ALLOW_IMAGE_TRANSFORM"))return n(t);const m=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),d=e("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),{crop:u}=a.getMetadata(),c=[];if(o(a.getMetadata(),(t,e)=>{s.includes(t)&&c.push({type:t,data:e})}),null===m&&null===d&&!u&&!c.length)return n(t);const p=(e,a)=>{imageDataToBlob(e,a).then(e=>{const a=i(e,((t,e)=>{return`${g(t)}.${"image/jpeg"===e?"jpg":e.split("/")[1]}`})(t.name,(t=>"image/jpeg"===t||"image/png"===t?t:"image/jpeg")(e.type)));n(a)}).catch(t=>{console.error(t)})},f=URL.createObjectURL(t);r(f).then(e=>{URL.revokeObjectURL(f);const n=(a.getMetadata("exif")||{}).orientation||-1,o=imageToImageData(e,u?u.rect:null,n);if(!c.length)return void p(o,{quality:m,type:d||t.type});const r=h(TransformWorker);r.post({transforms:c,imageData:o},e=>{p(objectToImageData(e),{quality:m,type:d||t.type}),r.terminate()},[o.data.buffer])})})),{options:{allowImageTransform:[!0,n.BOOLEAN],imageTransformOutputMimeType:[null,n.STRING],imageTransformOutputQuality:[null,n.INT]}}};document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:plugin$1}));export default plugin$1;